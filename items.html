<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Items â€“ Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    table { width:100%; border-collapse: collapse; margin-top:15px; }
    th, td { border:1px solid #ddd; padding:8px; font-size:14px; }
    th { background:#e0e0e0; }
    .btn-small {
      padding:6px 10px;
      background:#1976d2;
      color:#fff;
      border-radius:6px;
      text-decoration:none;
      font-size:12px;
    }
  </style>
</head>
<body>

<div class="card">
  <h1>Items</h1>

  <p class="rack">
    Rack: <span id="rackLabel"></span><br>
    Category: <span id="catLabel"></span><br>
    Action: <span id="actionLabel"></span>
  </p>

  <div id="itemsTableContainer">Loading...</div>

  <button class="btn" onclick="goBack()" style="background:#616161;">Back</button>
</div>

<script>
  const params   = new URLSearchParams(window.location.search);
  const rack     = params.get("rack");
  const role     = params.get("role");
  const name     = params.get("name");
  const code     = params.get("code");
  const action   = params.get("action");
  const category = params.get("category");

  document.getElementById("rackLabel").innerText   = rack;
  document.getElementById("catLabel").innerText    = category;
  document.getElementById("actionLabel").innerText = action;

  const API_URL = "https://script.google.com/macros/s/AKfycbznAEnny7WgiynnUwU96c8LuVM2OF7KxJvUQ5t67D0_Ouq4Ps9kbFM-PRbiyl3qVHU0/exec";

  async function loadTable() {
    const box = document.getElementById("itemsTableContainer");

    try {
      const res = await fetch(
        `${API_URL}?mode=items&rack=${encodeURIComponent(rack)}&category=${encodeURIComponent(category)}`
      );
      const data = await res.json();

      if (!data.ok || !data.items || !data.items.length) {
        box.innerHTML = "<p>No items found.</p>";
        return;
      }

      let html = "<table><thead><tr><th>ID</th><th>Name</th><th>Stock</th><th></th></tr></thead><tbody>";

      data.items.forEach(item => {
        // Build update.html link with itemName and stock so update page can validate
        const link =
          `update.html`
          + `?rack=${encodeURIComponent(rack)}`
          + `&role=${encodeURIComponent(role)}`
          + `&name=${encodeURIComponent(name)}`
          + `&code=${encodeURIComponent(code)}`
          + `&action=${encodeURIComponent(action)}`
          + `&category=${encodeURIComponent(category)}`
          + `&itemId=${encodeURIComponent(item.id)}`
          + `&itemName=${encodeURIComponent(item.name)}`
          + `&stock=${encodeURIComponent(item.stock)}`;

        html += `
          <tr>
            <td>${item.id}</td>
            <td>${item.name}</td>
            <td>${item.stock} ${item.unit || ""}</td>
            <td>
              <a class="btn-small" href="${link}">
                ${action === "VIEW" ? "Details" : "Select"}
              </a>
            </td>
          </tr>
        `;
      });

      html += "</tbody></table>";
      box.innerHTML = html;
    } catch (e) {
      console.error(e);
      box.innerHTML = "<p>Error loading items.</p>";
    }
  }

  loadTable();

  function goBack() {
    window.location.href =
      `home.html?rack=${encodeURIComponent(rack)}`
      + `&role=${encodeURIComponent(role)}`
      + `&name=${encodeURIComponent(name)}`
      + `&code=${encodeURIComponent(code)}`;
  }
</script>

</body>
</html>
